<head>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js"></script>
    </head>
    
    <body class="flex w-screen h-screen justify-center items-center">
    <div class="flex-col space-y-2 justify-center items-center">
    <button id='loginButton' onclick="" class="mx-auto rounded-md p-2 bg-purple-500 text-white">
    Login with MetaMask
    </button>

    <button id="authTelegram" onclick="verfiyTelegram()" class="mx-auto rounded-md p-2 bg-purple-500 text-white" style="visibility:hidden;">
        Verfiy your Telegram
    </button>
    <p id='userWallet' class='text-lg text-gray-600 my-2'></p>
    
    <pre id="codebox" style="visibility:hidden;"><code class="language-javascript"  id="connectData">
    function helloWorld() {
        console.log("Hello, World!");
    }
    </code></pre>
    </div>
    <script>
        window.userWalletAddress = null
        const loginButton = document.getElementById('loginButton')
        const userWallet = document.getElementById('userWallet')

        function toggleButton() {
            if (!window.ethereum) {
            loginButton.innerText = 'MetaMask is not installed'
            loginButton.classList.remove('bg-purple-500', 'text-white')
            loginButton.classList.add('bg-gray-500', 'text-gray-100', 'cursor-not-allowed')
            return false
            }

            loginButton.addEventListener('click', loginWithMetaMask)
        }

        async function loginWithMetaMask() {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })
            .catch((e) => {
            console.error(e.message)
            return
            })
            if (!accounts) { return }

            window.userWalletAddress = accounts[0]
            userWallet.innerText = window.userWalletAddress
            loginButton.innerText = 'Sign out of MetaMask'
            document.getElementById("authTelegram").style.visibility='visible'
            document.getElementById("codebox").style.visibility='visible'
            console.log("Unhidden the button telegram",document.getElementById("authTelegram").style.visibility)

            loginButton.removeEventListener('click', loginWithMetaMask)
            setTimeout(() => {
            loginButton.addEventListener('click', signOutOfMetaMask)
            }, 200)
        }

        function signOutOfMetaMask() {
            window.userWalletAddress = null
            userWallet.innerText = ''
            loginButton.innerText = 'Sign in with MetaMask'
            document.getElementById("authTelegram").style.visibility='hidden'
            document.getElementById("codebox").style.visibility='hidden'
            loginButton.removeEventListener('click', signOutOfMetaMask)
            setTimeout(() => {
            loginButton.addEventListener('click', loginWithMetaMask)
            }, 200)
        }

        window.addEventListener('DOMContentLoaded', () => {
        toggleButton()
        });

        function sleep (ms) {
            return new Promise((resolve) => {
              setTimeout(resolve, ms);
            });
        }

        async function verfiyTelegram()
        {
            const data = window.userWalletAddress;
            window.open("https://t.me/xxx/xxx?startapp="+data,"_blank")
            await loopCheck()
        }
        
        async function loopCheck()
        {
            let baseUrl = "https://xx.xx.xx/api/result/"+window.userWalletAddress
            while(true)
            {
                await sleep(1000);
                const check = await req(baseUrl)
                console.log(check);
                if(check && check?.code == 200)
                {
                    let finaldata = delete check.data.sign
                    document.getElementById("connectData").innerHTML = JSON.stringify(check.data, null, 2);
                    
                    break;
                }
            }
        }
        
        async function req(url) {
          try {
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`Response status: ${response.status}`);
            }
        
            const json = await response.json();
            console.log(json);
            return json
          } catch (error) {
            console.error(error.message);
            return false
          }
        }
    </script>
    </body>